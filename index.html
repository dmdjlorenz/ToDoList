<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TO DO LIST</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ffffff">
    <link rel="icon" href="/ic√¥ne.png" type="image/png">
    <link rel="apple-touch-icon" href="/ic√¥ne.png">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 800px;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .sort-btn {
            display: block;
            margin: 10px auto;
            padding: 10px 20px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .sort-btn:hover {
            background-color: #1976D2;
        }

        .table-container {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #ddd;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }

        th {
            background-color: #f0f0f0;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .record-container {
            text-align: center;
            margin-top: 20px;
        }

        .record-label {
            display: block;
            margin-bottom: 10px;
            font-size: 16px;
            color: #333;
        }

        .record-btn {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 60px;
            height: 60px;
            background-color: #2196F3;
            border-radius: 50%;
            border: none;
            font-size: 24px;
            cursor: pointer;
            margin: 0 auto;
        }

        .record-btn.recording {
            background-color: #f44336;
        }

        .record-btn::before {
            content: "üé§";
            color: black;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 400px;
            text-align: center;
        }

        .modal-content textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
        }

        .modal-content input[type="date"] {
            width: 100%;
            margin-bottom: 10px;
            padding: 10px;
        }

        .modal-content input[type="file"] {
            margin-bottom: 10px;
        }

        .modal-content button {
            margin: 5px;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .modal-content button:first-of-type {
            background-color: #2196F3;
            color: white;
        }

        .modal-content button:last-of-type {
            background-color: #f44336;
            color: white;
        }

        .icon-btn {
            cursor: pointer;
            font-size: 18px;
        }

        .icon-btn.micro::before {
            content: "üé§";
        }

        .icon-btn.delete::before {
            content: "üóëÔ∏è";
        }

        .icon-btn.attachment::before {
            content: "+";
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: #2196F3;
            color: white;
        }

        .attachment-list {
            list-style: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .attachment-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .attachment-list a {
            color: #2196F3;
            text-decoration: none;
        }

        .notification {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #ff69b4;
            color: white;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 2;
            margin-bottom: 10px;
        }

        .notification button {
            margin-left: 10px;
            background-color: #000000;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        @media (max-width: 600px) {
            th, td {
                padding: 8px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TO DO LIST</h1>
        <button id="sort-btn" class="sort-btn">Changer en Date/T√¢che</button>
        <div class="table-container">
            <table id="tasks-table">
                <thead>
                    <tr>
                        <th>Enrg</th>
                        <th>T√¢che</th>
                        <th>Date</th>
                        <th>PJ</th>
                        <th>Supp</th>
                    </tr>
                </thead>
                <tbody id="tasks-body"></tbody>
            </table>
        </div>
        <div class="record-container">
            <span id="record-label" class="record-label">Clique pour enregistrer</span>
            <button id="record-btn" class="record-btn"></button>
        </div>
    </div>

    <!-- Modal for editing summary -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h2>Modifier le r√©sum√©</h2>
            <textarea id="edit-summary"></textarea>
            <button id="save-edit">Valider</button>
            <button id="cancel-edit">Annuler</button>
        </div>
    </div>

    <!-- Modal for date picker -->
    <div id="date-modal" class="modal">
        <div class="modal-content">
            <h2>S√©lectionner une date</h2>
            <input type="date" id="edit-date">
            <button id="save-date">Valider</button>
            <button id="cancel-date">Annuler</button>
        </div>
    </div>

    <!-- Modal for attachments -->
    <div id="attachment-modal" class="modal">
        <div class="modal-content">
            <h2>G√©rer les pi√®ces jointes</h2>
            <input type="file" id="attachment-input" accept=".pdf,.doc,.docx,image/*" multiple>
            <button id="add-attachment">Ajouter</button>
            <ul id="attachment-list" class="attachment-list"></ul>
            <button id="close-attachment">Fermer</button>
        </div>
    </div>

    <!-- Modal for confirmation -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content">
            <h2>Confirmer la suppression</h2>
            <p>√ätes-vous s√ªr de vouloir supprimer cette t√¢che ?</p>
            <button id="confirm-delete">Oui</button>
            <button id="cancel-delete">Non</button>
        </div>
    </div>

    <!-- Notifications container -->
    <div id="notifications-container"></div>

    <!-- Hidden audio player -->
    <audio id="audio-player" controls style="display: none;"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tasksBody = document.getElementById('tasks-body');
            const recordBtn = document.getElementById('record-btn');
            const recordLabel = document.getElementById('record-label');
            const audioPlayer = document.getElementById('audio-player');
            const sortBtn = document.getElementById('sort-btn');
            const notificationsContainer = document.getElementById('notifications-container');

            const editModal = document.getElementById('edit-modal');
            const editSummary = document.getElementById('edit-summary');
            const saveEdit = document.getElementById('save-edit');
            const cancelEdit = document.getElementById('cancel-edit');

            const dateModal = document.getElementById('date-modal');
            const editDate = document.getElementById('edit-date');
            const saveDate = document.getElementById('save-date');
            const cancelDate = document.getElementById('cancel-date');

            const attachmentModal = document.getElementById('attachment-modal');
            const attachmentInput = document.getElementById('attachment-input');
            const addAttachment = document.getElementById('add-attachment');
            const attachmentList = document.getElementById('attachment-list');
            const closeAttachment = document.getElementById('close-attachment');

            const confirmModal = document.getElementById('confirm-modal');
            const confirmDelete = document.getElementById('confirm-delete');
            const cancelDelete = document.getElementById('cancel-delete');

            let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
            let currentEditIndex = -1;
            let currentDeleteIndex = -1;
            let currentAttachmentIndex = -1;
            let mediaRecorder;
            let audioChunks = [];
            let recognition;
            let transcript = '';
            let isSortedByDate = false;

            // Initialize SpeechRecognition
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'fr-FR';
                recognition.interimResults = true;
                recognition.continuous = true;

                recognition.onresult = (event) => {
                    transcript = Array.from(event.results)
                        .map(result => result[0].transcript)
                        .join(' ');
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                };
            } else {
                alert('La reconnaissance vocale n\'est pas support√©e sur ce navigateur.');
            }

            // Load tasks
            function loadTasks() {
                tasksBody.innerHTML = '';
                let displayTasks = [...tasks];
                if (isSortedByDate) {
                    displayTasks.sort((a, b) => {
                        if (!a.date && !b.date) return 0;
                        if (!a.date) return 1;
                        if (!b.date) return -1;
                        return new Date(a.date) - new Date(b.date);
                    });
                } else {
                    displayTasks.reverse();
                }

                displayTasks.forEach((task, index) => {
                    const row = document.createElement('tr');
                    
                    // Enrg column
                    const enrgCell = document.createElement('td');
                    const microBtn = document.createElement('span');
                    microBtn.classList.add('icon-btn', 'micro');
                    microBtn.onclick = () => playAudio(task.audioData);
                    enrgCell.appendChild(microBtn);
                    row.appendChild(enrgCell);

                    // T√¢che/Date column
                    const taskCell = document.createElement('td');
                    const dateCell = document.createElement('td');
                    if (isSortedByDate) {
                        dateCell.textContent = task.date || '';
                        dateCell.onclick = () => openDateModal(tasks.indexOf(task));
                        taskCell.textContent = task.summary;
                        taskCell.onclick = () => openEditModal(tasks.indexOf(task));
                    } else {
                        taskCell.textContent = task.summary;
                        taskCell.onclick = () => openEditModal(tasks.indexOf(task));
                        dateCell.textContent = task.date || '';
                        dateCell.onclick = () => openDateModal(tasks.indexOf(task));
                    }
                    row.appendChild(isSortedByDate ? dateCell : taskCell);
                    row.appendChild(isSortedByDate ? taskCell : dateCell);

                    // PJ column
                    const attachmentCell = document.createElement('td');
                    const attachmentBtn = document.createElement('span');
                    attachmentBtn.classList.add('icon-btn', 'attachment');
                    attachmentBtn.onclick = () => openAttachmentModal(tasks.indexOf(task));
                    attachmentCell.appendChild(attachmentBtn);
                    row.appendChild(attachmentCell);

                    // Supp column
                    const suppCell = document.createElement('td');
                    const deleteBtn = document.createElement('span');
                    deleteBtn.classList.add('icon-btn', 'delete');
                    deleteBtn.onclick = () => openConfirmModal(tasks.indexOf(task));
                    suppCell.appendChild(deleteBtn);
                    row.appendChild(suppCell);

                    tasksBody.appendChild(row);
                });
            }

            // Play audio
            function playAudio(base64Audio) {
                const audioBlob = base64ToBlob(base64Audio, 'audio/webm');
                const audioUrl = URL.createObjectURL(audioBlob);
                audioPlayer.src = audioUrl;
                audioPlayer.play();
            }

            // Base64 to Blob
            function base64ToBlob(base64, mime) {
                const byteChars = atob(base64);
                const byteArrays = [];
                for (let offset = 0; offset < byteChars.length; offset += 512) {
                    const slice = byteChars.slice(offset, offset + 512);
                    const byteNumbers = new Array(slice.length);
                    for (let i = 0; i < slice.length; i++) {
                        byteNumbers[i] = slice.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    byteArrays.push(byteArray);
                }
                return new Blob(byteArrays, { type: mime });
            }

            // Extract date from transcript
            function extractDate(trans) {
                const dateRegex = /\b(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})\b/;
                const match = trans.match(dateRegex);
                if (match) {
                    const day = match[1].padStart(2, '0');
                    const month = match[2].padStart(2, '0');
                    const year = match[3];
                    return `${year}-${month}-${day}`;
                }
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                if (trans.toLowerCase().match(/\bdemain\b/)) {
                    return tomorrow.toISOString().split('T')[0];
                }
                const days = ['lundi', 'mardi', 'mercredi', 'jeudi', 'vendredi', 'samedi', 'dimanche'];
                for (let i = 0; i < days.length; i++) {
                    if (trans.toLowerCase().match(new RegExp(`\\b${days[i]} prochain\\b`))) {
                        const today = new Date();
                        const currentDay = today.getDay();
                        const targetDay = i + 1;
                        const daysUntil = (targetDay - currentDay + 7) % 7 || 7;
                        const nextDate = new Date();
                        nextDate.setDate(today.getDate() + daysUntil);
                        return nextDate.toISOString().split('T')[0];
                    }
                }
                const monthNames = ['janvier', 'f√©vrier', 'mars', 'avril', 'mai', 'juin', 'juillet', 'ao√ªt', 'septembre', 'octobre', 'novembre', 'd√©cembre'];
                const monthRegex = new RegExp(`\\ble\\s+(\\d{1,2})\\s+(${monthNames.join('|')})(?:\\s+(\\d{4}))?\\b`, 'i');
                const monthMatch = trans.match(monthRegex);
                if (monthMatch) {
                    const day = monthMatch[1].padStart(2, '0');
                    const monthIndex = monthNames.indexOf(monthMatch[2].toLowerCase()) + 1;
                    const year = monthMatch[3] || new Date().getFullYear();
                    return `${year}-${monthIndex.toString().padStart(2, '0')}-${day}`;
                }
                return '';
            }

            // Start/stop recording
            recordBtn.onclick = () => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                    recognition.stop();
                    recordBtn.classList.remove('recording');
                    recordLabel.textContent = 'Clique pour enregistrer';
                } else {
                    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                        mediaRecorder = new MediaRecorder(stream);
                        audioChunks = [];
                        transcript = '';

                        mediaRecorder.ondataavailable = (event) => {
                            audioChunks.push(event.data);
                        };

                        mediaRecorder.onstop = () => {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            const reader = new FileReader();
                            reader.readAsDataURL(audioBlob);
                            reader.onloadend = () => {
                                const base64Audio = reader.result.split(',')[1];
                                const date = extractDate(transcript);
                                const summary = transcript || 'Nouvelle t√¢che';
                                tasks.push({
                                    audioData: base64Audio,
                                    transcript: transcript,
                                    summary: summary,
                                    date: date,
                                    attachments: []
                                });
                                localStorage.setItem('tasks', JSON.stringify(tasks));
                                loadTasks();
                                checkNotifications();
                            };
                        };

                        mediaRecorder.start();
                        recognition.start();
                        recordBtn.classList.add('recording');
                        recordLabel.textContent = 'Clique pour arr√™ter';
                    }).catch(err => {
                        console.error('Error accessing microphone:', err);
                    });
                }
            };

            // Open edit modal
            function openEditModal(index) {
                currentEditIndex = index;
                editSummary.value = tasks[index].summary;
                editModal.style.display = 'flex';
            }

            saveEdit.onclick = () => {
                tasks[currentEditIndex].summary = editSummary.value;
                localStorage.setItem('tasks', JSON.stringify(tasks));
                loadTasks();
                editModal.style.display = 'none';
            };

            cancelEdit.onclick = () => {
                editModal.style.display = 'none';
            };

            // Open date modal
            function openDateModal(index) {
                currentEditIndex = index;
                editDate.value = tasks[index].date;
                dateModal.style.display = 'flex';
            }

            saveDate.onclick = () => {
                tasks[currentEditIndex].date = editDate.value;
                localStorage.setItem('tasks', JSON.stringify(tasks));
                loadTasks();
                dateModal.style.display = 'none';
                checkNotifications();
            };

            cancelDate.onclick = () => {
                dateModal.style.display = 'none';
            };

            // Open attachment modal
            function openAttachmentModal(index) {
                currentAttachmentIndex = index;
                attachmentList.innerHTML = '';
                tasks[index].attachments.forEach((attachment, attIndex) => {
                    const li = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = attachment.data;
                    link.textContent = attachment.name;
                    link.download = attachment.name;
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Supprimer';
                    deleteBtn.onclick = () => {
                        tasks[index].attachments.splice(attIndex, 1);
                        localStorage.setItem('tasks', JSON.stringify(tasks));
                        openAttachmentModal(index);
                    };
                    li.appendChild(link);
                    li.appendChild(deleteBtn);
                    attachmentList.appendChild(li);
                });
                attachmentModal.style.display = 'flex';
            }

            addAttachment.onclick = () => {
                const files = attachmentInput.files;
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => {
                        tasks[currentAttachmentIndex].attachments.push({
                            name: file.name,
                            data: reader.result
                        });
                        localStorage.setItem('tasks', JSON.stringify(tasks));
                        openAttachmentModal(currentAttachmentIndex);
                    };
                }
            };

            closeAttachment.onclick = () => {
                attachmentModal.style.display = 'none';
                attachmentInput.value = '';
            };

            // Open confirm modal
            function openConfirmModal(index) {
                currentDeleteIndex = index;
                confirmModal.style.display = 'flex';
            }

            confirmDelete.onclick = () => {
                tasks.splice(currentDeleteIndex, 1);
                localStorage.setItem('tasks', JSON.stringify(tasks));
                loadTasks();
                confirmModal.style.display = 'none';
                checkNotifications();
            };

            cancelDelete.onclick = () => {
                confirmModal.style.display = 'none';
            };

            // Sort button toggle
            sortBtn.onclick = () => {
                isSortedByDate = !isSortedByDate;
                sortBtn.textContent = isSortedByDate ? 'Changer en T√¢che/Date' : 'Changer en Date/T√¢che';
                document.querySelector('thead tr').innerHTML = `
                    <th>Enrg</th>
                    <th>${isSortedByDate ? 'Date' : 'T√¢che'}</th>
                    <th>${isSortedByDate ? 'T√¢che' : 'Date'}</th>
                    <th>PJ</th>
                    <th>Supp</th>
                `;
                loadTasks();
            };

            // Notification logic
            function checkNotifications() {
                notificationsContainer.innerHTML = '';
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                tasks.forEach((task, index) => {
                    if (task.date) {
                        const taskDate = new Date(task.date);
                        taskDate.setHours(0, 0, 0, 0);
                        const diffDays = Math.floor((taskDate - today) / (1000 * 60 * 60 * 24));
                        if (diffDays <= 3 && diffDays >= 0) {
                            const notification = document.createElement('div');
                            notification.className = 'notification';
                            notification.innerHTML = `
                                <span>Rappel : "${task.summary}" est pr√©vu pour le ${task.date}</span>
                                <button onclick="this.parentElement.style.display='none'">Fermer</button>
                            `;
                            notificationsContainer.appendChild(notification);
                            notification.style.display = 'block';
                        }
                    }
                });
            }

            // Check notifications periodically
            setInterval(checkNotifications, 60 * 60 * 1000); // Check every hour
            checkNotifications(); // Initial check

            // Register service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js', { scope: '/' })
                    .then(reg => console.log('Service Worker registered', reg))
                    .catch(err => console.error('Service Worker registration failed', err));
            }

            loadTasks();
        });
    </script>
</body>
</html>
